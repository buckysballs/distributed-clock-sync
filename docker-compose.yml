version: "3.8"

services:
  genesis:
    build:
      context: .
      dockerfile: local-dev/Dockerfile
    container_name: clocksync-genesis
    hostname: genesis
    environment:
      NODE_TYPE: genesis
      NODE_ID: node-genesis
      HTTP_PORT: "9000"
      P2P_PORT: "9001"
      METRICS_PORT: "9002"
      OSC_PORT: "9050"
      GENESIS_HOST: genesis
      INITIAL_BPM: "120.0"
      JAVA_OPTS: "-Xmx512m -XX:+UseG1GC"
    ports:
      - "9000:9000"   # HTTP
      - "9001:9001"   # P2P
      - "9002:9002"   # Metrics
      - "9050:9050/udp" # OSC
    volumes:
      - genesis-data:/app/data
      - genesis-proofs:/app/proofs
    networks:
      clocksync-net:
        ipv4_address: 172.28.1.1
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  validator1:
    build:
      context: .
      dockerfile: local-dev/Dockerfile
    container_name: clocksync-validator1
    hostname: validator1
    environment:
      NODE_TYPE: validator1
      NODE_ID: node-validator1
      HTTP_PORT: "9010"
      P2P_PORT: "9011"
      METRICS_PORT: "9012"
      OSC_PORT: "9060"
      GENESIS_HOST: genesis
      INITIAL_BPM: "120.0"
      JAVA_OPTS: "-Xmx512m -XX:+UseG1GC"
    ports:
      - "9010:9010"
      - "9011:9011"
      - "9012:9012"
      - "9060:9060/udp"
    volumes:
      - validator1-data:/app/data
      - validator1-proofs:/app/proofs
    networks:
      clocksync-net:
        ipv4_address: 172.28.1.2
    depends_on:
      genesis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9010/health"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 15s

  validator2:
    build:
      context: .
      dockerfile: local-dev/Dockerfile
    container_name: clocksync-validator2
    hostname: validator2
    environment:
      NODE_TYPE: validator2
      NODE_ID: node-validator2
      HTTP_PORT: "9020"
      P2P_PORT: "9021"
      METRICS_PORT: "9022"
      OSC_PORT: "9070"
      GENESIS_HOST: genesis
      INITIAL_BPM: "120.0"
      JAVA_OPTS: "-Xmx512m -XX:+UseG1GC"
    ports:
      - "9020:9020"
      - "9021:9021"
      - "9022:9022"
      - "9070:9070/udp"
    volumes:
      - validator2-data:/app/data
      - validator2-proofs:/app/proofs
    networks:
      clocksync-net:
        ipv4_address: 172.28.1.3
    depends_on:
      genesis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9020/health"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 15s

networks:
  clocksync-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  genesis-data:
  genesis-proofs:
  validator1-data:
  validator1-proofs:
  validator2-data:
  validator2-proofs:
